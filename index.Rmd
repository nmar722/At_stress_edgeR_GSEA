---
title: "EdgeR analysis of Arabidopsis stress RNAseq data with GSE"
author: "M. Naoumkina"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    number_sections: true
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## EdgeR analysis of RNAseq data of Arabidopsis stress experiment

The RNAseq count data from transcription profiling experiment by high throughput sequencing of Arabidopsis plants in response to a combination of salt and heat stress have been downloaded from [Expression Atlas website](https://www.ebi.ac.uk/gxa/experiments/E-GEOD-72806/Downloads).

```{r load-edgeR, message=FALSE}
# Load edgeR
library(edgeR)
```

### Load the data and create DGE list

```{r load-data}
# Load the count data
raw_counts <- read.delim("E-GEOD-72806-raw-counts.tsv", stringsAsFactors = FALSE)
# Preserve gene ID and gene name
gene_info <- raw_counts[, c("Gene.ID", "Gene.Name")]
# Extract count matrix (assuming counts start from column 3 onward)
count_matrix <- raw_counts[, 3:ncol(raw_counts)]
# Set rownames to Gene.ID
rownames(count_matrix) <- raw_counts$Gene.ID
```

```{r}
# Load metadata
metadata <- read.delim("E-GEOD-72806-experiment-design.tsv", stringsAsFactors = FALSE)
colnames(metadata)
# Extract condition factor from metadata
condition <- factor(metadata[["Factor.Value.environmental.stress."]],
                    levels = c("none", "heat stress", "salt stress", "salt and heat stress"),
                    labels = c("control", "heat", "salt", "salt_heat"))
# Reorder columns in count matrix to match metadata
counts <- count_matrix[, metadata$Run]
# Ensure sample order matches
counts <- counts[, metadata$Run]
length(condition) == ncol(counts)  # Should return TRUE
```
```{r}
# Create DGEList object
dge <- DGEList(counts = counts, group = condition)
```

### Filtering and normalization

```{r}
# Filtering
keep <- filterByExpr(dge)
table(keep)
dge <- dge[keep, , keep.lib.sizes = FALSE] # Filter low-expression genes
nrow(dge$counts) # check retained genes after filtering
dge <- normLibSizes(dge)    # Recalculate library sizes
# Normalize for composition bias
dge <- calcNormFactors(dge, method = "TMM") 
```

### Visualize sample relationship

```{r mds-plot, fig.width=6, fig.height=6}
plotMDS(dge, col = as.numeric(dge$samples$group))
legend("bottom", inset = 0.02,
       legend = levels(dge$samples$group),
       col = 1:length(levels(dge$samples$group)),
       pch = 16,       # filled circles
       ncol = 2,       # compact layout
       horiz = FALSE,  # stacked rows
       bty = "n")
```

### Differential gene expression analysis
```{r}
#Design matrix
design <- model.matrix(~ 0 + condition)
colnames(design) <- levels(condition)
#Estimate dispersion
dge <- estimateDisp(dge, design)
plotBCV(dge)
#Check design matrix
colnames(design)
```

```{r}
# Define multiple contrasts
contrasts <- makeContrasts(
  heat_vs_control = heat - control,
  salt_vs_control = salt - control,
  heat_salt_vs_control = salt_heat - control,
  levels = design)
```

```{r}
#Fit the Quasi-Likelihood Model
fit <- glmQLFit(dge, design)
```

```{r}
#Set up threshold for DEGs (absolute logFC â‰¥ 1) 
tr_heat <- glmTreat(fit, contrast = contrasts[,"heat_vs_control"], lfc = log2(2)) 

#Classify and visualize
is.de_heat <- decideTests(tr_heat)
summary(is.de_heat)

plotMD(tr_heat, status = is.de_heat,
       main = "MA Plot: Heat vs Control",
       xlab = "Average logCPM", ylab = "log2 Fold Change")
```

```{r}
# Extract data table with DEGs
res_heat <- topTags(tr_heat, n = Inf)$table
head(res_heat)
write.csv(res_heat, "DE_res_heat.csv")
```

